<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Validate signature demo</title>

  <!-- Woleet web libs (regular version) -->
  <script src="../dist/woleet-weblibs.js"></script>

  <!-- Woleet web libs (minified version) -->
  <!--<script src="../dist/woleet-weblibs.min.js"></script>-->

  <script>
    window.onload = function () {

      let r = document.getElementById('result');
      let _receipt = null;

      window.setReceipt = function (receipt) {
        r.innerText = '';
        let reader = new FileReader();

        reader.onloadend = function (e) {
          try {
            _receipt = JSON.parse(e.target.result);
            check();
          }
          catch (error) {
            r.innerText = 'Error while parsing receipt, is it a JSON file?';
          }
        };

        reader.readAsText(receipt);
      };

      function check() {
        r.innerText = 'pending ...';

        if (!_receipt.signature || !_receipt.signature.signedHash || !_receipt.signature.pubKey
          || !_receipt.signature.signature)
          return r.innerText = 'No signature in receipt';

        // Build the message that should have been signed
        let message = _receipt.signature.signedHash;
        if (_receipt.signature.signedIdentity || _receipt.signature.signedIssuerDomain) {
          message = woleet.crypto.sha256().update(_receipt.signature.signedHash + (_receipt.signature
            .signedIdentity || '') + (_receipt.signature.signedIssuerDomain || '')).digest('hex');
        }

        woleet.signature.validateSignature(message, _receipt.signature.pubKey, _receipt
          .signature.signature)
          .then(success => {
            r.innerText = 'Success: ' + JSON.stringify(success, null, 4);
          }, function (error) {
            r.innerText = 'Error: ' + JSON.stringify(error, null, 4);
          });
      }
    }

  </script>
</head>

<body>
<h3>Validate signature demo</h3>
Choose a signature receipt:
<input type="file" onchange="setReceipt(this.files.item(0))">
<p id="result"></p>
</body>

</html>
